---
title: 'Biostatistics Task 2'
author: 'Danyu Zhang & Daniel Alonso'
date: 'May 28th, 2021'
output: 'pdf_document'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = '#>',
fig.path = './figures/'
)
knitr::knit_engines$set(julia = JuliaCall::eng_juliacall)
options(JULIA_HOME = '/home/dreth/julia/bin')
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(survival)
library(ggplot2)
library(coin)
```

## Exercise 1

```{r, echo=FALSE, warning=FALSE, message=FALSE}
range <- seq(1,10, length.out=100)
hazard <- sapply(range, function(t) {ifelse(t > 5, 0.4, 0.07)})
cumulative_hazard <- sapply(hazard, function(t) {ifelse(t == 0.4, 0.47, 0.07)})
survival <- exp(-1* cumulative_hazard)
df <- data.frame(time=range, hazard=hazard, cumulative_hazard=cumulative_hazard, survival=survival)
```

### Hazard plot

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data=df, aes(x=time, y=hazard)) + geom_line() + ggtitle('Hazard function')
```

### Survival plot

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data=df, aes(x=time, y=survival)) + geom_line() + ggtitle('Survival function')
```

### Survival times simulation

\small

```{r, echo=TRUE, warning=FALSE, message=FALSE}
# number of trials
trials <- 1000
time_length <- 1000
survival_prob <- c(1, rep(0.9323938, 5), rep(0.6250023, time_length-6))

# t is in seconds
survival_times <- rep(0,trials)
for (i in 1:trials) {
    time = 1
    while (time < time_length) {
        if (runif(1,0,1) > survival_prob[time]) {
            break
        } else {
            time = time + 1
        }
    }
    survival_times[i] <- time
}
```

\normalsize

### Histogram for survival times

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
hist(survival_times)
```

### Median survival time

```{r, echo=FALSE, warning=FALSE, message=FALSE}
median(survival_times)
```

## Exercise 2

Given the following density function:

$$f(y) = (\lambda_0 + \lambda_1 y) e^{-\lambda_0 y - \frac{1}{2} \lambda_1 y^2}$$

We obtain the survival function as follows:

$$\begin{split} S(t) = P(T > t) & = \int_{t}^{\infty} (\lambda_0 + \lambda_1 y) e^{-\lambda_0 y - \frac{1}{2} \lambda_1 y^2} dy \\
& = \lim_{b\to\infty} [- e^{\frac{\lambda_1 b^2}{2} - \lambda_0 b}] + e^{\frac{-\lambda_1 t^2}{2}- \lambda_0 t} \\
& = 0 + e^{\frac{-\lambda_1 t^2}{2}- \lambda_0 t} \\
S(t) & = e^{\frac{-\lambda_1 t^2}{2}- \lambda_0 t}, \text{ } \lambda_1 \in \mathbb{R}, \lambda_0 > 0 \end{split}$$

We obtain the hazard function as follows:

$$h(t) = \frac{f(t)}{S(t)} = \frac{(\lambda_0 + \lambda_1 t) e^{-\lambda_0 t - \frac{1}{2} \lambda_1 t^2}}{e^{-\lambda_0 t - \frac{1}{2} \lambda_1 t^2}} = \lambda_0 + \lambda_1 t$$

$$h(t) = \lambda_0 + \lambda_1 t$$

And the cumulative hazard function:

$$H(t) = -log(S(t)) = \frac{\lambda_1 t^2}{2} + \lambda_0 t$$

## Exercise 3

### KM estimator implementation of the survival function
```{r, echo=FALSE, warning=FALSE, message=FALSE}
km_est <- function(dataset, events) {
    # calculate survival probabilities
    n_c <- length(dataset[,1])
    survival <- c(1)
    j = 0
    for (i in 1:length(dataset[,1])) {
        if (events[i] == 1) {
            j = j+1
            prob <- (1-(1/n_c))*survival[j]
            survival <- c(survival, prob)
        }    
        n_c <- n_c - 1    
    }
    return(survival)
}
```

### Utilizing the function to obtain the survival function for the leukaemia dataset

The survival probabilities are as follows, and these change over time at the times displayed on the *time* column of this table:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
df <- aml[aml$x == 'Maintained',]
events <- df$status
survival <- km_est(dataset=df, events=events)
event_times <- df[df$status == 1,'time']
```
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
# plotting the probs
j = 1
probs <- c()
for (i in 1:max(df$time)) {
    if (i %in% event_times) {
        j = j+1
    } 
    probs <- c(probs, survival[j])
}
probs <- data.frame(time=1:max(df$time), survival=probs)
ggplot(data=probs, aes(x=time, y=survival)) + geom_line()
```

## Exercise 4

### KM estimate of the survival function

We can see the estimate as follows:

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
henning <- read.table('./Henning.txt', header=TRUE)
fit <- survfit(Surv(henning$months, henning$censor)~1)
plot(fit, xlab="Months", ylab="Survival")
```

### Survival function: with crimes against persons

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
henning2 <- henning[henning$personal==1,]
fit_persons1 <- survfit(Surv(henning2$months, henning2$censor)~1)
plot(fit_persons1, xlab="Months", ylab="Survival")
```

### Survival function: without crimes against persons

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
henning2 <- henning[henning$personal==0,]
fit_persons2 <- survfit(Surv(henning2$months, henning2$censor)~1)
plot(fit_persons2, xlab="Months", ylab="Survival")
```

### Comparing both curves

We can see that the curve for nonpersonal crimes decays faster after the 15th month.
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# plot both curves
fit=survfit(Surv(months,censor)~personal,data=henning)
plot(fit,lty=1:2,col=1:2,xlab="months",ylab="Survival")
legend(c(75,150),c(0.8,1),legend=c("With personal","Without personal"),lty=1:2,col=1:2)
```

### Low-rank test

```{r, echo=FALSE, warning=FALSE, message=FALSE}
survdiff(Surv(months,censor)~personal,data=henning)
```

### Survival function: with crimes against property

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
henning2 <- henning[henning$property==1,]
fit_property1 <- survfit(Surv(henning2$months, henning2$censor)~1)
plot(fit_property1, xlab="Months", ylab="Survival")
```

### Survival function: with crimes against property

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
henning2 <- henning[henning$property==0,]
fit_property2 <- survfit(Surv(henning2$months, henning2$censor)~1)
plot(fit_property2, xlab="Months", ylab="Survival")
```

### Comparing both curves

We can see that the curve for nonpersonal crimes decays faster after the 15th month.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# plot both curves
fit=survfit(Surv(months,censor)~property,data=henning)
plot(fit,lty=1:2,col=1:2,xlab="months",ylab="Survival")
legend(c(75,150),c(0.8,1),legend=c("With property","Without property"),lty=1:2,col=1:2)
```

### Low-rank test

```{r, echo=FALSE, warning=FALSE, message=FALSE}
survdiff(Surv(months,censor)~property,data=henning)
```

### Fitting a Cox regression

Converting personal and property to leveled factors with labels yes/no.

\footnotesize

```{r, echo=FALSE, warning=FALSE, message=FALSE}
henning$personal=factor(henning$personal,levels=c("0","1"),labels=c("no","yes"))
henning$property=factor(henning$property,levels=c("0","1"),labels=c("no","yes"))
head(henning)
```

\normalsize

Running the cox regression fit.

\footnotesize

```{r, echo=FALSE, warning=FALSE, message=FALSE}
fit.all = coxph(Surv(months,censor) ~ cage + personal + property , henning)
summary(fit.all)
```

\normalsize

According to the p-value on our Wald test, we can see that 

The dummy variables personal and property are not significant, given that they have a large p-val. The variable cage, which is centered age (in years) at time of release is significant, and positive, which means that it increases the probability of survival as it increases.

## Exercise 5

Given a hazard function $h(t) = c$, where $c > 0$:

We obtain the cumulative hazard function $H(t)$:

$$\begin{split} H(t) & = \int_0^{t} h(u) du \\
& = c \int_0^{t} du \\
& = ct \end{split}$$

With this, we derive the survival function $S(t)$:

$$\begin{split} H(t) & = ct \\ H(t) & = - log(S(t)) \\ ct & = -log(S(t)) \\ S(t) & = e^{-ct} \end{split}$$

And then we obtain the density function $f(t)$:

$$\begin{split} h(t) & = \frac{f(t)}{S(t)} \\
c & = \frac{f(t)}{e^{-ct}} \\
f(t) & = c e^{-ct} \end{split}$$

### Calculating mean failure time with $c = 5$

We note the functions with $c = 5$ are:

$$\begin{split} h(t) & = 5 \\ H(t) & = 5t \\ S(t) & = e^{-5t} \\ f(t) & = 5 e^{-5t} \end{split}$$ 
 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# number of trials
trials <- 100000
time_length <- 1000
survival_prob <- sapply(1:time_length, function(t) {exp(-5*t)})

# t is in seconds
survival_times <- rep(0,trials)
for (i in 1:trials) {
    time = 1
    while (time < time_length) {
        if (runif(1,0,1) > survival_prob[time]) {
            break
        } else {
            time = time + 1
        }
    }
    survival_times[i] <- time
}
```

The mean failure time, according to 100,000 simulations with a length of time of 1000, is as follows:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
mean(survival_times)
```

## Exercise 6

First we read the data:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# reading the data
lungcancer = read.table(file="http://www.mayo.edu/research/documents/lungdat/DOC-10027697", sep="",header=F, col.names=c("inst", "time", "status", "age", "sex", "ECOG","Karnofsky.physician", "Karnofsky.patient", "calories", "weight.loss"))
head(lungcancer)
```

