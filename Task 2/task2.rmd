---
title: 'Biostatistics Task 2'
author: 'Danyu Zhang & Daniel Alonso'
date: 'May 21st, 2021'
output: 'pdf_document'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = '#>',
fig.path = './figures/'
)
knitr::knit_engines$set(julia = JuliaCall::eng_juliacall)
options(JULIA_HOME = '/home/dreth/julia/bin')
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(survival)
library(ggplot2)
```

## Exercise 1

```{r, echo=FALSE, warning=FALSE, message=FALSE}
range <- seq(1,10, length.out=100)
hazard <- sapply(range, function(t) {ifelse(t > 5, 0.4, 0.07)})
cumulative_hazard <- sapply(hazard, function(t) {ifelse(t == 0.4, 0.47, 0.07)})
survival <- exp(-1* cumulative_hazard)
df <- data.frame(time=range, hazard=hazard, cumulative_hazard=cumulative_hazard, survival=survival)
```

### Hazard plot

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data=df, aes(x=time, y=hazard)) + geom_line() + ggtitle('Hazard function')
```

### Survival plot

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data=df, aes(x=time, y=survival)) + geom_line() + ggtitle('Survival function')
```

### Survival times simulation

\small

```{r, echo=TRUE, warning=FALSE, message=FALSE}
# number of trials
trials <- 1000
time_length <- 1000
survival_prob <- c(1, rep(0.9323938, 5), rep(0.6250023, time_length-6))

# t is in seconds
survival_times <- rep(0,trials)
for (i in 1:trials) {
    time = 1
    while (time < time_length) {
        if (runif(1,0,1) > survival_prob[time]) {
            break
        } else {
            time = time + 1
        }
    }
    survival_times[i] <- time
}
```

\normalsize

### Histogram for survival times

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
hist(survival_times)
```

### Median survival time

```{r, echo=FALSE, warning=FALSE, message=FALSE}
median(survival_times)
```

## Exercise 2

Given the following density function:

$$f(y) = (\lambda_0 + \lambda_1 y) e^{-\lambda_0 y - \frac{1}{2} \lambda_1 y^2}$$

We obtain the survival function as follows:

$$\begin{split} S(t) = P(T > t) & = \int_{t}^{\infty} (\lambda_0 + \lambda_1 y) e^{-\lambda_0 y - \frac{1}{2} \lambda_1 y^2} dy \\
& = \lim_{b\to\infty} [- e^{\frac{\lambda_1 b^2}{2} - \lambda_0 b}] + e^{\frac{-\lambda_1 t^2}{2}- \lambda_0 t} \\
& = 0 + e^{\frac{-\lambda_1 t^2}{2}- \lambda_0 t} \\
S(t) & = e^{\frac{-\lambda_1 t^2}{2}- \lambda_0 t}, \text{ } \lambda_1 \in \mathbb{R}, \lambda_0 > 0 \end{split}$$

We obtain the hazard function as follows:

$$h(t) = \frac{f(t)}{S(t)} = \frac{(\lambda_0 + \lambda_1 t) e^{-\lambda_0 t - \frac{1}{2} \lambda_1 t^2}}{e^{-\lambda_0 t - \frac{1}{2} \lambda_1 t^2}} = \lambda_0 + \lambda_1 t$$

$$h(t) = \lambda_0 + \lambda_1 t$$

And the cumulative hazard function:

$$H(t) = -log(S(t)) = \frac{\lambda_1 t^2}{2} + \lambda_0 t$$

## Exercise 3

### KM estimator implementation of the survival function
```{r, echo=FALSE, warning=FALSE, message=FALSE}
km_est <- function(dataset, events) {
    # calculate survival probabilities
    n_c <- length(dataset[,1])
    survival <- c(1)
    j = 0
    for (i in 1:length(dataset[,1])) {
        if (events[i] == 1) {
            j = j+1
            prob <- (1-(1/n_c))*survival[j]
            survival <- c(survival, prob)
        }    
        n_c <- n_c - 1    
    }
    return(survival)
}
```

### Utilizing the function to obtain the survival function for the leukaemia dataset

The survival probabilities are as follows, and these change over time at the times displayed on the *time* column of this table:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
df <- aml[aml$x == 'Maintained',]
events <- df$status
survival <- km_est(dataset=df, events=events)
event_times <- df[df$status == 1,'time']
```
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.width=5}
# plotting the probs
j = 1
probs <- c()
for (i in 1:max(df$time)) {
    if (i %in% event_times) {
        j = j+1
    } 
    probs <- c(probs, survival[j])
}
probs <- data.frame(time=1:max(df$time), survival=probs)
ggplot(data=probs, aes(x=time, y=survival)) + geom_line()
```

## Exercise 4

```{r, echo=FALSE, warning=FALSE, message=FALSE}

```

## Exercise 5

```{r, echo=FALSE, warning=FALSE, message=FALSE}

```

## Exercise 6

```{r, echo=FALSE, warning=FALSE, message=FALSE}

```

